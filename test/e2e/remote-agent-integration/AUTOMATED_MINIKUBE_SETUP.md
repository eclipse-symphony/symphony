# è‡ªåŠ¨åŒ–Minikubeé›†ç¾¤ç®¡ç†

æœ¬E2Eæµ‹è¯•æ¡†æ¶ç°åœ¨åŒ…å«äº†è‡ªåŠ¨åŒ–çš„Minikubeé›†ç¾¤ç®¡ç†åŠŸèƒ½ï¼Œç¡®ä¿æ¯ä¸ªæµ‹è¯•éƒ½åœ¨å…¨æ–°ã€éš”ç¦»çš„ç¯å¢ƒä¸­è¿è¡Œã€‚

## åŠŸèƒ½ç‰¹æ€§

### ğŸ”„ è‡ªåŠ¨é›†ç¾¤ç®¡ç†
- **è‡ªåŠ¨åˆ›å»º**ï¼šæµ‹è¯•å¼€å§‹æ—¶è‡ªåŠ¨åˆ›å»ºå…¨æ–°çš„minikubeé›†ç¾¤
- **è‡ªåŠ¨æ¸…ç†**ï¼šæµ‹è¯•ç»“æŸåè‡ªåŠ¨åˆ é™¤æ•´ä¸ªé›†ç¾¤
- **å®Œå…¨éš”ç¦»**ï¼šæ¯æ¬¡æµ‹è¯•éƒ½åœ¨ç‹¬ç«‹çš„ç¯å¢ƒä¸­è¿è¡Œ

### ğŸ“‹ å‰ç½®æ¡ä»¶æ£€æŸ¥
- Goç¯å¢ƒéªŒè¯
- Minikubeå®‰è£…æ£€æŸ¥
- Dockerå®ˆæŠ¤ç¨‹åºçŠ¶æ€
- Kubectlå¯ç”¨æ€§éªŒè¯

### ğŸš€ ä¸€é”®æµ‹è¯•æ‰§è¡Œ
```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼ˆåŒ…å«è‡ªåŠ¨minikubeç®¡ç†ï¼‰
./run_tests.sh

# è¿è¡Œç‰¹å®šæµ‹è¯•ç±»å‹
./run_tests.sh -t http -v

# ä½¿ç”¨è‡ªå®šä¹‰è¶…æ—¶æ—¶é—´
./run_tests.sh -T 30m
```

## æµ‹è¯•æµç¨‹

### å®Œæ•´çš„ç«¯åˆ°ç«¯æµç¨‹
1. **ç¯å¢ƒæ£€æŸ¥** - éªŒè¯æ‰€æœ‰å¿…éœ€å·¥å…·
2. **é›†ç¾¤åˆ›å»º** - å¯åŠ¨å…¨æ–°minikubeé›†ç¾¤ï¼ˆçº¦2-3åˆ†é’Ÿï¼‰
3. **è¯ä¹¦ç”Ÿæˆ** - åˆ›å»ºæµ‹è¯•æ‰€éœ€çš„TLSè¯ä¹¦
4. **Secretåˆ›å»º** - åœ¨Kubernetesä¸­åˆ›å»ºè¯ä¹¦Secret
5. **Symphonyéƒ¨ç½²** - ä½¿ç”¨è¯ä¹¦é…ç½®å¯åŠ¨Symphony
6. **æµ‹è¯•æ‰§è¡Œ** - è¿è¡Œremote agenté€šä¿¡æµ‹è¯•
7. **è‡ªåŠ¨æ¸…ç†** - åˆ é™¤minikubeé›†ç¾¤å’Œæ‰€æœ‰èµ„æº

### æ—¶é—´é¢„æœŸ
- **HTTPæµ‹è¯•**: ~10-15åˆ†é’Ÿ
- **MQTTæµ‹è¯•**: ~15-20åˆ†é’Ÿ
- **å®Œæ•´æµ‹è¯•å¥—ä»¶**: ~25-30åˆ†é’Ÿ

## å…³é”®æ”¹è¿›

### ğŸ¯ è§£å†³çš„é—®é¢˜
- âœ… **è¯ä¹¦ä¿¡ä»»é—®é¢˜**: è‡ªåŠ¨åˆ›å»ºæ­£ç¡®çš„Certificate Secret
- âœ… **ç¯å¢ƒä¸€è‡´æ€§**: æ¯æ¬¡æµ‹è¯•éƒ½ä½¿ç”¨ç›¸åŒçš„é›†ç¾¤é…ç½®
- âœ… **ä¾èµ–ç®¡ç†**: è‡ªåŠ¨å¤„ç†minikubeå’ŒSymphonyçš„å¯åŠ¨
- âœ… **èµ„æºå†²çª**: å®Œå…¨éš”ç¦»çš„æµ‹è¯•ç¯å¢ƒ

### ğŸ”§ è‡ªåŠ¨åŒ–é…ç½®
```yaml
# Minikubeé›†ç¾¤é…ç½®
Memory: 4096MB
CPUs: 2
Disk: 20GB
Driver: docker
Wait: all components ready

# Symphony Helmé…ç½®
remoteAgent.remoteCert.used: true
remoteAgent.remoteCert.trustCAs.secretName: client-cert-secret
remoteAgent.remoteCert.trustCAs.secretKey: client-cert-key  
remoteAgent.remoteCert.subjects: MyRootCA
http.enabled: true
```

### ğŸ“¦ Certificateç®¡ç†
```bash
# CA Secret (cert-manager namespace)
Name: client-cert-secret
Key: client-cert-key -> CAè¯ä¹¦å†…å®¹

# Client Secret (æµ‹è¯•namespace)  
Name: remote-agent-client-secret
Keys: client.crt, client.key

# å®¢æˆ·ç«¯è¯ä¹¦Subject
CN=MyRootCA (å›ºå®šå€¼ï¼ŒåŒ¹é…Symphonyä¿¡ä»»é…ç½®)
```

## ä½¿ç”¨æŒ‡å—

### åŸºæœ¬ç”¨æ³•
```bash
cd test/e2e/remote-agent-integration

# è¿è¡ŒHTTPé€šä¿¡æµ‹è¯•
./run_tests.sh -t http

# è¿è¡ŒMQTTé€šä¿¡æµ‹è¯•
./run_tests.sh -t mqtt

# è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼ˆæ¨èï¼‰
./run_tests.sh
```

### é«˜çº§é€‰é¡¹
```bash
# å¯ç”¨è¯¦ç»†è¾“å‡º
./run_tests.sh -v

# è‡ªå®šä¹‰è¶…æ—¶æ—¶é—´ï¼ˆé€‚ç”¨äºæ…¢æœºå™¨ï¼‰
./run_tests.sh -T 35m

# ä»…è¿è¡ŒHTTPæµ‹è¯•ä¸”è¯¦ç»†è¾“å‡º
./run_tests.sh -t http -v -T 20m
```

### æ•…éšœæ’é™¤
```bash
# å¦‚æœæµ‹è¯•å¤±è´¥ï¼Œæ£€æŸ¥å‰ç½®æ¡ä»¶
./run_tests.sh --help

# æ‰‹åŠ¨éªŒè¯ç¯å¢ƒ
minikube version
docker info
kubectl version --client
```

## ç¯å¢ƒè¦æ±‚

### å¿…éœ€å·¥å…·
- **Go** 1.19+
- **Minikube** 1.25+
- **Docker** 20.10+
- **Kubectl** 1.24+

### ç³»ç»Ÿèµ„æº
- **å†…å­˜**: è‡³å°‘6GBå¯ç”¨ï¼ˆ4GBç»™minikube + 2GBç»™ç³»ç»Ÿï¼‰
- **CPU**: è‡³å°‘4æ ¸å¿ƒï¼ˆ2æ ¸ç»™minikube + 2æ ¸ç»™ç³»ç»Ÿï¼‰
- **ç£ç›˜**: è‡³å°‘30GBå¯ç”¨ç©ºé—´

### ç½‘ç»œè¦æ±‚
- Dockerå®ˆæŠ¤ç¨‹åºè¿è¡Œ
- èƒ½å¤Ÿæ‹‰å–Dockeré•œåƒ
- æ— é˜²ç«å¢™é˜»æ­¢minikubeé€šä¿¡

## é”™è¯¯å¤„ç†

### å¸¸è§é—®é¢˜

1. **Minikubeå¯åŠ¨å¤±è´¥**
   ```bash
   # æ¸…ç†å¹¶é‡è¯•
   minikube delete
   ./run_tests.sh
   ```

2. **Dockeræƒé™é—®é¢˜**
   ```bash
   # ç¡®ä¿ç”¨æˆ·åœ¨dockerç»„ä¸­
   sudo usermod -aG docker $USER
   newgrp docker
   ```

3. **èµ„æºä¸è¶³**
   ```bash
   # é‡Šæ”¾å†…å­˜å¹¶é‡è¯•
   docker system prune -f
   ./run_tests.sh -T 40m
   ```

## æ¶æ„ä¼˜åŠ¿

### ğŸ”’ å®Œå…¨éš”ç¦»
æ¯ä¸ªæµ‹è¯•è¿è¡Œåœ¨ç‹¬ç«‹çš„minikubeé›†ç¾¤ä¸­ï¼Œæ¶ˆé™¤äº†æµ‹è¯•é—´çš„ç›¸äº’å½±å“ã€‚

### ğŸ¯ çœŸå®ç¯å¢ƒ
ä½¿ç”¨å®Œæ•´çš„Kubernetesé›†ç¾¤å’ŒçœŸå®çš„Symphonyéƒ¨ç½²ï¼Œç¡®ä¿æµ‹è¯•ç»“æœçš„å¯ä¿¡åº¦ã€‚

### âš¡ å¹¶è¡Œå®‰å…¨
å¤šä¸ªæµ‹è¯•å®ä¾‹å¯ä»¥å¹¶è¡Œè¿è¡Œè€Œä¸ä¼šç›¸äº’å¹²æ‰°ã€‚

### ğŸ”„ å¯é‡å¤æ€§
æ¯æ¬¡æµ‹è¯•éƒ½åœ¨ç›¸åŒçš„åˆå§‹çŠ¶æ€ä¸‹å¼€å§‹ï¼Œç¡®ä¿ç»“æœä¸€è‡´æ€§ã€‚

---

è¿™ä¸ªè‡ªåŠ¨åŒ–æ¡†æ¶ä½¿remote agentçš„E2Eæµ‹è¯•å˜å¾—ç®€å•ã€å¯é ä¸”çœŸæ­£ç«¯åˆ°ç«¯ã€‚æ— éœ€æ‰‹åŠ¨ç®¡ç†é›†ç¾¤æˆ–æ‹…å¿ƒç¯å¢ƒçŠ¶æ€ï¼Œåªéœ€è¿è¡Œæµ‹è¯•è„šæœ¬å³å¯ï¼
