{{- if .Values.observability.fluentbit.enabled }}
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: {{ include "symphony.fullname" . }}-fluent-bit
  labels:
    app: {{ include "symphony.appSelector" . }}-fluent-bit
  namespace: {{ .Release.Namespace }}
spec:
  selector:
    matchLabels:
      app: {{ include "symphony.appSelector" . }}-fluent-bit
  template:
    metadata:
      labels:
        app: {{ include "symphony.appSelector" . }}-fluent-bit
    spec:
      containers:
        - name: fluent-bit
          image: {{ .Values.observability.fluentbit.image }}
          command: ["/fluent-bit/bin/fluent-bit", "-c", "/fluent-bit/etc/fluent-bit.yaml"]
          resources:
            limits:
              memory: 500Mi
            requests:
              cpu: 100m
              memory: 200Mi
          volumeMounts:
            - name: varlog
              mountPath: /var/log
            - name: varlibdockercontainers
              mountPath: /var/lib/docker/containers
              readOnly: true
            - name: fluent-bit-config
              mountPath: /fluent-bit/etc
      terminationGracePeriodSeconds: 10
      serviceAccountName: '{{ include "symphony.fullname" . }}-logforwarder'
      volumes:
        - name: varlog
          hostPath:
            path: /var/log
        - name: varlibdockercontainers
          hostPath:
            path: /var/lib/docker/containers
        - name: fluent-bit-config
          configMap:
            name: {{ include "symphony.fullname" . }}-fluent-bit-config
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: '{{ include "symphony.fullname" . }}-logforwarder'
  labels:
    app.kubernetes.io/name: '{{ include "symphony.fullname" . }}-logforwarder'
    app.kubernetes.io/instance: {{ .Release.Name }}
rules:
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: '{{ include "symphony.fullname" . }}-logforwarder'
  labels:
    app.kubernetes.io/name: '{{ include "symphony.fullname" . }}-logforwarder'
    app.kubernetes.io/instance: {{ .Release.Name }}
roleRef:
  kind: ClusterRole
  apiGroup: rbac.authorization.k8s.io
  name: '{{ include "symphony.fullname" . }}-logforwarder'
subjects:
  - kind: ServiceAccount
    name: '{{ include "symphony.fullname" . }}-logforwarder'
    namespace: {{ .Release.Namespace }}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: '{{ include "symphony.fullname" . }}-logforwarder'
  namespace: {{ .Release.Namespace }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "symphony.fullname" . }}-fluent-bit-config
  namespace: {{ .Release.Namespace }}
data:
  # https://github.com/fluent/fluent-bit/blob/master/conf/parsers.conf
  parsers.conf: |
    [PARSER]
      # http://rubular.com/r/tjUt3Awgg4
      Name cri
      Format regex
      Regex ^(?<time>[^ ]+) (?<stream>stdout|stderr) (?<logtag>[^ ]*) (?<message>.*)$
      Time_Key    time
      Time_Format %Y-%m-%dT%H:%M:%S.%L%z
      Time_Keep   On

    [PARSER]
      Name         docker
      Format       json
      Time_Key     time
      Time_Format  %Y-%m-%dT%H:%M:%S.%L
      Time_Keep    On

  fluent-bit.yaml: |
    service:
      flush: 1
      parsers_file: parsers.conf
      log_level: debug

    pipeline:
      inputs:
      - name: tail
        path: /var/log/containers/symphony-controller-manager*_{{ .Release.Namespace }}_*.log
        multiline.parser: cri
        tag: kube.*
      - name: tail
        path: /var/log/containers/symphony-api*_{{ .Release.Namespace }}_*.log
        multiline.parser: cri
        tag: kube.*
      filters:
      - name: kubernetes
        match: kube.*
        kube_url: https://kubernetes.default.svc:443
        kube_ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        kube_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        kube_tag_prefix: kube.var.log.containers.
        merge_log: on
      outputs:
      - name: stdout
        match: kube.*
        format: json_lines
      {{- if .Values.otlpLogsEndpointGrpc }}
      - name: forward
        match: kube.*
        host: {{ include "symphony.fullname" . }}-otel-forwarder-service.{{ .Release.Namespace }}.svc
        port: 24284
      {{- end }}

{{- end }}